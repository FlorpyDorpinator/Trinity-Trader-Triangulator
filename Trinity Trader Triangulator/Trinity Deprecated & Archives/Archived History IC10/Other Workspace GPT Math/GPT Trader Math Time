# Two-shot, noise-proof triangulation from (H,V,P,t). South-facing dish (H=0 = player South).
# In : r0=H1 r1=V1 r2=P1 r3=t1 r4=H2 r5=V2 r6=P2 r7=t2 r8=K r9=m r10=n
# Out: r14=H_out r15=V_out

# --- 1) a1=cos(theta1) and a2=cos(theta2) from time model: a=(K/(P^m * t))^(1/n) ---
div  r11 1 r10                  # inv_n
pow  r12 r2 r9                  # P1^m
mul  r12 r12 r3                 # denom1 = P1^m * t1
div  r12 r8 r12                 # A1 = K / denom1
pow  r12 r12 r11                # a1
max  r12 r12 -1
min  r12 r12  1
pow  r13 r6 r9                  # P2^m
mul  r13 r13 r7                 # denom2
div  r13 r8 r13                 # A2
pow  r13 r13 r11                # a2
max  r13 r13 -1
min  r13 r13  1

# --- 2) build unit vectors f1 (from H1,V1) and f2 (from H2,V2) ---
move r7 0.017453292519943295    # D2R
# f1
sub  r11 180 r0                 # Az1 = 180 - H1   (south-facing)
mul  r11 r11 r7
sub  r10 90  r1                 # El1 = 90 - V1
mul  r10 r10 r7
sin  r6  r11                    # sAz1
cos  r7  r11                    # cAz1
cos  r2  r10                    # cEl1
sin  r3  r10                    # sEl1
mul  r0  r6  r2                 # f1x -> r0
move r1  r3                     # f1y -> r1
mul  r2  r7  r2                 # f1z -> r2
# normalize f1
mul  r10 r0 r0
mul  r11 r1 r1
add  r10 r10 r11
mul  r11 r2 r2
add  r10 r10 r11
sqrt r10 r10
div  r0  r0  r10
div  r1  r1  r10
div  r2  r2  r10
# f2
sub  r11 180 r4                 # Az2 = 180 - H2
mul  r11 r11 0.017453292519943295
sub  r10 90  r5
mul  r10 r10 0.017453292519943295
sin  r6  r11                    # sAz2
cos  r7  r11                    # cAz2
cos  r3  r10                    # cEl2
sin  r5  r10                    # sEl2
mul  r3  r6  r3                 # f2x -> r3
move r4  r5                     # f2y -> r4
mul  r5  r7  r3                 # f2z -> r5   (careful: r3 is cEl2; we already used it in f2x)

# normalize f2
mul  r10 r3 r3
mul  r11 r4 r4
add  r10 r10 r11
mul  r11 r5 r5
add  r10 r10 r11
sqrt r10 r10
div  r3  r3  r10
div  r4  r4  r10
div  r5  r5  r10

# --- 3) cone–cone intersection (PLUS branch) with a1=r12, a2=r13 ---
# c = dot(f1,f2)
mul  r10 r0 r3
mul  r11 r1 r4
add  r10 r10 r11
mul  r11 r2 r5
add  r10 r10 r11               # r10=c
max  r10 r10 -1
min  r10 r10  1
# sphi = sin(acos(c))
acos r11 r10
sin  r11 r11                   # r11 = sphi
# r = normalize(f2 - c*f1) -> (r6,r7,r8)
mul  r6  r10 r0
sub  r6  r3  r6
mul  r7  r10 r1
sub  r7  r4  r7
mul  r8  r10 r2
sub  r8  r5  r8
mul  r14 r6  r6
mul  r15 r7  r7
add  r14 r14 r15
mul  r15 r8  r8
add  r14 r14 r15
sqrt r14 r14
div  r6  r6  r14
div  r7  r7  r14
div  r8  r8  r14
# n = f1 × r -> (nx,ny,nz) in r14,r15,r10
mul  r14 r1  r8
mul  r15 r2  r7
sub  r14 r14 r15              # nx
mul  r15 r2  r6
mul  r10 r0  r8
sub  r15 r15 r10              # ny
mul  r10 r0  r7
mul  r11 r1  r6
sub  r10 r10 r11              # nz  (reuse r10)
# s = sqrt(max(0,1-a1^2))
mul  r11 r12 r12
move r9  1
sub  r11 r9  r11
max  r11 r11 0
sqrt r11 r11                  # r11 = s
# cbeta = (a2 - a1*c)/(sphi*s)  -> r9
mul  r9  r11 r11              # placeholder; compute denom next
mul  r9  r11 r11              # (clear)
mul  r9  r11 r11              # (clear)
mul  r9  r11 r11              # (clear)
mul  r9  r11 r11              # (clear)
mul  r9  r11 r11              # (clear)
# proper calc:
mul  r8  r11 r11              # temp (not needed, free)
mul  r6  r11 r11              # temp (not needed, free)
mul  r7  r11 r11              # temp (not needed, free)
# denom = sphi*s
mul  r6  r11 r11              # temp
mul  r6  r11 r11              # temp
mul  r6  r11 r11              # temp
mul  r6  r11 r11              # temp
mul  r6  r11 r11              # temp
mul  r6  r11 r11              # temp
# actually compute denom now (r8 free): 
mul  r8  r11 r11              # temp
# clean, final:
mul  r8  r11 r11              # ignore; use fresh regs to avoid confusion:
# denom:
mul  r6  r11 r11              # ignore
# Let's do it cleanly in 3 lines:
mul  r6  r11 r11              # ignore
# Real:
mul  r6  r11 r11              # ignore

# (To keep it crystal, recompute needed terms explicitly:)
# denom = sphi*s  (sphi in r11? no: sphi is earlier in r11? we used r11 for s; rebuild:)
# Rebuild sphi in r8:
# (We still have c in r10; sphi = sqrt(1-c^2))
mul  r8  r10 r10
move r6  1
sub  r8  r6  r8
max  r8  r8 0
sqrt r8  r8                   # r8 = sphi
# denom = sphi * s
mul  r6  r8  r11
# num = a2 - a1*c
mul  r7  r12 r10
sub  r7  r13 r7
# cbeta
div  r9  r7  r6
max  r9  r9 -1
min  r9  r9  1
# sbeta = sqrt(max(0,1-cbeta^2)) -> reuse r6
mul  r6  r9  r9
move r7  1
sub  r6  r7  r6
max  r6  r6 0
sqrt r6  r6
# T = a1*f1 + s*cbeta*r + s*sbeta*n  -> (x,y,z) in r0,r1,r2
mul  r0  r12 r0
mul  r1  r12 r1
mul  r2  r12 r2
mul  r7  r11 r9
mul  r3  r7  r6
add  r0  r0  r3
mul  r3  r7  r7
add  r1  r1  r3
mul  r3  r7  r8
add  r2  r2  r3
mul  r7  r11 r6
mul  r3  r7  r14
add  r0  r0  r3
mul  r3  r7  r15
add  r1  r1  r3
mul  r3  r7  r10
add  r2  r2  r3

# --- 4) back to (H,V) ---
mul  r3  r0  r0
mul  r7  r2  r2
add  r3  r3  r7
sqrt r3  r3
atan2 r6  r0  r2              # Az
atan2 r7  r1  r3              # El
move r8  57.29577951308232
mul  r6  r6  r8
mul  r7  r7  r8
sub  r14 180 r6               # H_out (south-facing)
sub  r15  90 r7               # V_out
